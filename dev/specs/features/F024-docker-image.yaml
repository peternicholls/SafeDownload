metadata:
  id: "F024"
  name: "Docker Image"
  version: "1.3.0"
  sprint: 13
  status: "planned"
  priority: "P3"
  story_points: 5
  created: "2025-12-25"
  updated: "2025-12-25"

description: |
  Create an official Docker image for SafeDownload, enabling containerized
  deployment for CI/CD pipelines, automated workflows, and isolated execution.

  The image will be Alpine-based for minimal size and published to Docker Hub
  and GitHub Container Registry.

constitution_compliance:
  principles:
    - id: "II"
      name: "Zero-Configuration"
      notes: "docker run provides instant isolated environment"

user_stories:
  - id: "US024-1"
    priority: "P3"
    title: "Run SafeDownload in container"
    description: |
      As a DevOps engineer,
      I want to run SafeDownload in a container,
      So that I can integrate it into CI/CD pipelines.

    acceptance_criteria:
      - "GIVEN Docker installed, WHEN docker pull safedownload, THEN image pulled"
      - "GIVEN image pulled, WHEN docker run safedownload [url], THEN download completes"
      - "GIVEN volume mounted, WHEN download completes, THEN file on host"

    independent_test: |
      1. Run: docker pull ghcr.io/peternicholls/safedownload
      2. Run: docker run -v $(pwd)/downloads:/downloads ghcr.io/peternicholls/safedownload https://example.com/file.zip
      3. Verify: File downloaded to ./downloads/

    definition_of_done:
      - "Image builds successfully"
      - "Image < 50MB"
      - "Downloads work with volume mounts"

  - id: "US024-2"
    priority: "P3"
    title: "Multi-architecture support"
    description: |
      As a user with ARM hardware,
      I want Docker image for my architecture,
      So that I can run SafeDownload natively.

    acceptance_criteria:
      - "GIVEN ARM Mac, WHEN docker pull, THEN arm64 image pulled"
      - "GIVEN x86 Linux, WHEN docker pull, THEN amd64 image pulled"

    independent_test: |
      1. On ARM64: docker pull ghcr.io/peternicholls/safedownload
      2. Verify: arm64 variant pulled
      3. Run: docker run safedownload --version
      4. Verify: Runs natively (no emulation)

    definition_of_done:
      - "linux/amd64 image available"
      - "linux/arm64 image available"
      - "Manifest list published"

functional_requirements:
  - id: "FR024-1"
    description: "System MUST provide Alpine-based Docker image"
    priority: "MUST"
    test: "docker run succeeds"

  - id: "FR024-2"
    description: "System MUST support volume mounts for downloads"
    priority: "MUST"
    test: "Downloaded files accessible on host"

  - id: "FR024-3"
    description: "System SHOULD support multi-architecture"
    priority: "SHOULD"
    test: "Image runs on amd64 and arm64"

  - id: "FR024-4"
    description: "System SHOULD publish to multiple registries"
    priority: "SHOULD"
    test: "Image available on Docker Hub and GHCR"

implementation:
  dockerfile:
    path: "Dockerfile"
    content: |
      # Build stage
      FROM golang:1.22-alpine AS builder

      WORKDIR /app
      COPY go.mod go.sum ./
      RUN go mod download
      COPY . .
      RUN CGO_ENABLED=0 go build -ldflags="-s -w" -o safedownload ./cmd/safedownload

      # Runtime stage
      FROM alpine:3.19

      RUN apk add --no-cache ca-certificates

      COPY --from=builder /app/safedownload /usr/local/bin/safedownload

      # Default download directory
      VOLUME /downloads
      WORKDIR /downloads

      ENTRYPOINT ["safedownload"]

  registries:
    - name: "ghcr.io/peternicholls/safedownload"
      primary: true
    - name: "docker.io/peternicholls/safedownload"
      mirror: true

  github_action:
    workflow: ".github/workflows/docker.yml"
    content: |
      name: Docker

      on:
        push:
          tags: ['v*']

      jobs:
        build:
          runs-on: ubuntu-latest
          steps:
            - uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push
              uses: docker/build-push-action@v5
              with:
                push: true
                platforms: linux/amd64,linux/arm64
                tags: |
                  ghcr.io/peternicholls/safedownload:latest
                  ghcr.io/peternicholls/safedownload:${{ github.ref_name }}

testing:
  manual_tests:
    - "Build image locally"
    - "Run download with volume mount"
    - "Test on ARM64 (Apple Silicon)"
    - "Test on amd64 (Intel/AMD)"
    - "Verify image size < 50MB"

documentation:
  readme_sections:
    - section: "Docker"
      changes: |
        Add Docker usage section:
        ```bash
        # Pull image
        docker pull ghcr.io/peternicholls/safedownload

        # Download a file
        docker run -v $(pwd)/downloads:/downloads \
          ghcr.io/peternicholls/safedownload \
          https://example.com/file.zip

        # Download with options
        docker run -v $(pwd)/downloads:/downloads \
          ghcr.io/peternicholls/safedownload \
          --parallel 4 --verify https://example.com/file.zip
        ```

  changelog:
    type: "Added"
    entry: |
      ### Docker Image (v1.3.0)
      - Official Alpine-based Docker image
      - Multi-architecture support (amd64, arm64)
      - Available on Docker Hub and GHCR

sprint_tasks:
  implementation:
    - task: "T024-001"
      description: "Create multi-stage Dockerfile"
      assignee: "@peternicholls"
      estimate: "1 SP"

    - task: "T024-002"
      description: "Create GitHub Action for multi-arch build"
      assignee: "@peternicholls"
      estimate: "1.5 SP"

    - task: "T024-003"
      description: "Set up GHCR and Docker Hub publishing"
      assignee: "@peternicholls"
      estimate: "1 SP"

  testing:
    - task: "T024-004"
      description: "Test on amd64 and arm64"
      assignee: "@peternicholls"
      estimate: "1 SP"

  documentation:
    - task: "T024-005"
      description: "Write Docker usage documentation"
      assignee: "@peternicholls"
      estimate: "0.5 SP"

notes: |
  Image targets:
  - Base: Alpine 3.19 for minimal size
  - Architectures: linux/amd64, linux/arm64
  - Registries: GHCR (primary), Docker Hub (mirror)

  Usage patterns:
  - CI/CD pipelines: download assets during builds
  - Isolated execution: sandboxed downloads
  - Scripting: integrate with docker-compose workflows
