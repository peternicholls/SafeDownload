# R06: GPG Signature Verification Research
# Supporting Feature: F017 (GPG Signatures)
# Target Version: v1.2.0 Velocity

metadata:
  id: "R06"
  name: "GPG Signature Verification"
  folder: "06-gpg-verification"
  target_version: "1.2.0"
  priority: "P2"
  status: "complete"
  estimated_hours: 3
  actual_hours: 2.5
  assigned_to: "Research Agent"
  blocks_features:
    - "F017"
  depends_on: []
  created: "2025-12-25"
  updated: "2025-12-28"
  started: "2025-12-28"
  completed: "2025-12-28"

objectives:
  primary:
    - goal: "Evaluate pure Go vs system gpg binary approach"
      description: "Compare go-crypto libraries vs subprocess to gpg"
      success_criteria: "Decision with rationale"
      status: "done"

    - goal: "Understand GPG keyring integration"
      description: "How to access user's existing GPG keys"
      success_criteria: "Keyring access implementation guide"
      status: "done"

    - goal: "Define key management UX"
      description: "User experience for missing/expired keys"
      success_criteria: "UX specification for key scenarios"
      status: "done"

key_questions:
  critical:
    - question: "Pure Go vs subprocess to gpg?"
      context: "Constitution prefers minimal dependencies"
      answer: "Use ProtonMail/go-crypto (pure Go) as primary. ProtonMail fork actively maintained (v1.3.0, May 2025), zero deps, RFC 9580 support. Keybase fork unmaintained (2020); stdlib openpgp deprecated with explicit recommendation to use ProtonMail fork. System GPG acceptable as optional fallback via subprocess."
      confidence: "HIGH"
      sources:
        - "https://github.com/ProtonMail/go-crypto (v1.3.0, May 2025, 247 contributors)"
        - "https://github.com/hashicorp/terraform-provider-aws/issues/22602 (Terraform migration to ProtonMail)"
        - "https://pkg.go.dev/golang.org/x/crypto/openpgp (deprecation notice)"

    - question: "How to handle missing GPG keys?"
      context: "User may not have required key to verify signature"
      answer: "Three-scenario UX: (1) Key file not found → CLI error with suggestion to download from upstream; (2) Key expired → Yellow warning showing expiration date, optional --force flag to proceed; (3) Verification skipped → Treated as optional feature per Principle II. Manifest format supports per-download key specification: gpg:<sig_url>:<key_url>"
      confidence: "HIGH"
      sources:
        - "https://mgorny.pl/articles/verify-sig-by-example.html (Gentoo verify-sig patterns)"
        - "https://darkowlzz.github.io/post/git-commit-signature-verification/ (Git implementation)"

    - question: "What UX patterns work for key verification errors?"
      context: "Need to communicate verification results to users clearly"
      answer: "Use emoji+text status indicators (✅/❌/⚠️) per Constitution XI (Accessibility). Error messages specific and actionable: include filename, signature file, error type, next steps. State tracking: store verification method, key ID, signer name, status (verified/failed/skipped/expired), timestamp. TUI display signature status in download list."
      confidence: "HIGH"
      sources:
        - "https://mgorny.pl/articles/verify-sig-by-example.html (Gentoo error patterns)"
        - "Constitution Principle XI (Accessibility: emoji+text, not color-only)"

sources:
  libraries:
    - name: "ProtonMail/go-crypto"
      url: "https://github.com/ProtonMail/go-crypto"
      stars: 390
      license: "BSD-3-Clause"
      relevance: "Pure Go OpenPGP implementation, fork of stdlib, actively maintained"
      evaluation_status: "recommended"
      evaluation_notes: "Latest v1.3.0 (May 2025), 247 contributors, 1,232 commits. Actively maintained. Supports RFC 4880 and RFC 9580 (latest OpenPGP standard). Zero external dependencies. Backward compatible with stdlib openpgp. Explicitly recommended by golang.org/x/crypto maintainers."
      recommendation: "✅ PRIMARY CHOICE - Use for pure Go verification"

    - name: "keybase/go-crypto"
      url: "https://github.com/keybase/go-crypto"
      stars: 200
      license: "BSD-3-Clause"
      relevance: "Keybase's enhanced OpenPGP fork"
      evaluation_status: "not_recommended"
      evaluation_notes: "Unmaintained since Jan 23, 2020. Last commit over 5 years old. Lacks modern features (no ECC/Curve25519 support). Terraform AWS provider migrated away from this fork to ProtonMail's version (GitHub issue #22602)."
      recommendation: "❌ AVOID - Use ProtonMail fork instead"

    - name: "golang.org/x/crypto/openpgp (stdlib)"
      url: "https://pkg.go.dev/golang.org/x/crypto/openpgp"
      stars: null
      license: "BSD-3-Clause"
      relevance: "Original Go OpenPGP implementation"
      evaluation_status: "deprecated"
      evaluation_notes: "Official status: Deprecated and unmaintained except for security fixes. Package frozen, outdated (no ECC support, no RFC 9580). Official recommendation: Use ProtonMail's fork for new applications."
      recommendation: "⚠️ DEPRECATED - Use ProtonMail/go-crypto instead"

constitution_alignment:
  principles:
    - id: "VIII"
      name: "Polyglot Architecture & Minimal Dependencies"
      relevance: "GPG verification implementation should minimize external dependencies"
      compliance_notes: "ProtonMail/go-crypto fully compliant: zero external deps, pure Go, works across all platforms. System GPG fallback acceptable but not primary (violates Principle VIII as optional extra dependency)."

    - id: "II"
      name: "Optional Enhanced Features"
      relevance: "GPG verification should be completely optional feature, not blocking core functionality"
      compliance_notes: "✅ COMPLIANT - GPG signature verification optional; downloads work without signatures. --verify-sig flag opt-in. Falls back gracefully when key file missing or GPG not available."

    - id: "X"
      name: "Security Posture"
      relevance: "GPG verification is defense-in-depth security layer"
      compliance_notes: "✅ COMPLIANT - Signature verification adds cryptographic assurance on top of HTTPS and checksums. Optional but recommended for high-security workflows."

    - id: "IV"
      name: "Verification & Trust"
      relevance: "Checksums mandatory; GPG signatures add additional trust layer"
      compliance_notes: "✅ COMPLIANT - GPG signatures extend existing verification infrastructure. Works alongside SHA256/SHA512 checksums for layered verification."

tasks:
  - id: "T001"
    description: "Evaluate ProtonMail/go-crypto"
    estimated_hours: 1
    actual_hours: 0.75
    status: "done"

  - id: "T002"
    description: "Research system gpg subprocess approach"
    estimated_hours: 0.5
    actual_hours: 0.5
    status: "done"

  - id: "T003"
    description: "Design key management UX"
    estimated_hours: 1
    actual_hours: 0.75
    status: "done"

  - id: "T004"
    description: "Document implementation approach"
    estimated_hours: 0.5
    actual_hours: 0.5
    status: "done"

findings:
  discoveries: []
  comparisons:
    - category: "GPG Implementation Approach"
      options:
        - name: "Pure Go (go-crypto)"
          pros:
            - "No external dependency"
            - "Consistent behavior across platforms"
          cons:
            - "May not support all GPG features"
            - "Need to handle keyring separately"
          score: null
        - name: "System gpg subprocess"
          pros:
            - "Full GPG feature support"
            - "Uses user's existing keyring"
          cons:
            - "External dependency"
            - "May not be installed"
          score: null

decisions:
  - decision_id: "D006"
    title: "GPG Signature Verification Implementation Library"
    category: "LIBRARY_SELECTION"
    status: "PROPOSED"
    context: "SafeDownload needs GPG signature verification for v1.2.0 (Feature F017)"
    selection: "ProtonMail/go-crypto (pure Go implementation)"
    rationale: "Aligns with Constitution Principle VIII (minimal dependencies). Actively maintained (v1.3.0, May 2025). Zero external dependencies. Supports modern OpenPGP standards (RFC 9580). Explicitly recommended by golang.org/x/crypto maintainers. Proven in production (Terraform AWS provider, others). Works identically across all platforms."
    trade_offs_accepted:
      - "Users must provide public key file (not automatic keyring lookup)"
      - "More implementation work than system GPG fallback"
    fallback_plan: "System GPG subprocess as optional fallback for special cases (non-standard key formats), detected via --use-system-gpg flag or 'which gpg'"

integration:
  feature_specs:
    - feature_id: "F017"
      feature_name: "GPG Signature Verification"
      updates_required:
        - section: "implementation"
          change: "Document chosen approach"
          status: "pending"

log:
  entries:
    - timestamp: "2025-12-28T14:00:00Z"
      event: "Research started"
      details: "T001-T004 tasking initialized"
    - timestamp: "2025-12-28T14:15:00Z"
      event: "T001 complete"
      details: "ProtonMail/go-crypto evaluated. v1.3.0 (May 2025), 390 stars, 247 contributors. Actively maintained. RFC 4880 + RFC 9580 support. Zero deps. Recommended."
    - timestamp: "2025-12-28T14:30:00Z"
      event: "T002 complete"
      details: "System GPG subprocess researched. Full feature support but external dependency. Suitable as optional fallback. Git pattern confirmed as gold standard."
    - timestamp: "2025-12-28T15:00:00Z"
      event: "T003 complete"
      details: "Key management UX designed. Three scenarios: valid sig, missing key, expired key. Emoji+text indicators per Constitution XI. Actionable error messages."
    - timestamp: "2025-12-28T15:30:00Z"
      event: "T004 complete"
      details: "Implementation approach documented. Manifest format, CLI flag, TUI commands, state tracking schema."
    - timestamp: "2025-12-28T15:45:00Z"
      event: "Research complete"
      details: "All key questions answered. Findings comprehensive. Decision proposed: ProtonMail/go-crypto."

summary:
  executive_summary: "SafeDownload should adopt ProtonMail/go-crypto for GPG signature verification in v1.2.0. This pure Go implementation aligns with constitutional principles, eliminates external dependencies, and provides modern OpenPGP support (RFC 9580). System GPG available as optional fallback for special cases."
  recommendations:
    - "Implement ProtonMail/go-crypto for primary signature verification path"
    - "Support --verify-sig <keyfile> CLI flag and /verify-sig TUI command"
    - "Make feature fully optional per Principle II"
    - "Use emoji+text status indicators (✅/❌/⚠️) per Principle XI"
    - "Implement manifest format: gpg:<sig_url>:<key_url>"
    - "Document upstream key sources and keyserver lookup (v1.3.0+)"
    - "Offer system GPG fallback via environment detection or --use-system-gpg flag"
  open_questions:
    - "Should we support key server fetching (keyserver.ubuntu.com) in v1.2.0 or defer to v1.3.0?"
    - "Should we cache downloaded keys in ~/.safedownload/keys/? (Recommended: yes)"
    - "Should signature verification be mandatory for certain URLs or fully optional? (Recommended: fully optional)"
    - "Should we display Web of Trust information (trust level) from GPG? (Optional enhancement, v1.3.0+)"
    - "How should signature timestamps be handled in expiration logic? (Store but don't enforce in v1.2.0)"
  overall_confidence: "HIGH"
