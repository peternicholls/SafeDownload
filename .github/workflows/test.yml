# SafeDownload CI/CD Pipeline
# Constitution: v1.5.0 - Development Workflow & Quality Gates
#
# This workflow enforces:
# - Test coverage targets (≥80% Go, ≥60% Bash)
# - Performance gates (TUI <500ms, list <100ms)
# - Security scanning (gosec, trivy)
# - Multi-platform testing (Tier 1 platforms)

name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GO_VERSION: '1.21'
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # Linting
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ShellCheck (Bash scripts)
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          ignore_paths: 'archive'
          severity: warning

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: 'dev/'
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
              document-start: disable

      - name: Markdown Lint
        uses: articulate/actions-markdownlint@v1
        with:
          config: '.markdownlint.json'
          files: '**/*.md'
          ignore: 'archive'

  # ===========================================================================
  # v0.x Tests (Bash/Python)
  # ===========================================================================
  test-bash:
    name: Test (Bash v0.x)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install BATS
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y bats
          else
            brew install bats-core
          fi

      - name: Check curl version
        run: |
          curl --version
          # Constitution requires curl 7.60+
          CURL_VERSION=$(curl --version | head -1 | awk '{print $2}')
          echo "curl version: $CURL_VERSION"

      - name: Run unit tests
        run: |
          if [[ -f tests/test.sh ]]; then
            chmod +x tests/test.sh
            ./tests/test.sh
          else
            echo "No tests/test.sh found, skipping"
          fi

      - name: Run BATS E2E tests
        run: |
          if [[ -d tests/e2e ]]; then
            bats tests/e2e/*.bats
          else
            echo "No E2E tests found, skipping"
          fi

  # ===========================================================================
  # v1.x Tests (Go) - Enabled when Go code exists
  # ===========================================================================
  test-go:
    name: Test (Go v1.x)
    runs-on: ${{ matrix.os }}
    if: hashFiles('go.mod') != ''
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out | tee coverage.txt

      - name: Check coverage threshold
        run: |
          COVERAGE=$(grep total coverage.txt | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Coverage $COVERAGE% is below 80% threshold"
            exit 1
          fi
          echo "✅ Coverage $COVERAGE% meets 80% threshold"

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  # ===========================================================================
  # Integration Tests
  # ===========================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: hashFiles('go.mod') != ''
    needs: [lint, test-go]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run integration tests
        run: |
          if [[ -d tests/integration ]]; then
            go test -v -timeout 5m ./tests/integration/...
          else
            echo "No integration tests found, skipping"
          fi

  # ===========================================================================
  # Performance Benchmarks (Constitution Gates)
  # ===========================================================================
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: hashFiles('go.mod') != ''
    needs: [test-go]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Python (for benchmark check)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -benchtime=3s ./... | tee bench.txt

      - name: Check performance gates
        run: |
          python3 scripts/check_benchmarks.py bench.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: bench.txt

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        if: hashFiles('go.mod') != ''
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run gosec
        if: hashFiles('go.mod') != ''
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'

      - name: Upload gosec results
        if: hashFiles('go.mod') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================================================
  # Security Tests (HTTPS enforcement, credential leaks)
  # ===========================================================================
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    if: hashFiles('go.mod') != ''
    needs: [test-go]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run security tests
        run: |
          if [[ -d tests/security ]]; then
            go test -v ./tests/security/...
          else
            echo "No security tests found, skipping"
          fi

  # ===========================================================================
  # Accessibility Tests
  # ===========================================================================
  accessibility:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    if: hashFiles('go.mod') != ''
    needs: [test-go]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run accessibility tests
        run: |
          if [[ -d tests/accessibility ]]; then
            go test -v ./tests/accessibility/...
          else
            echo "No accessibility tests found, skipping"
          fi

  # ===========================================================================
  # Build (Multi-platform)
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    if: hashFiles('go.mod') != ''
    needs: [test-go, lint]
    strategy:
      matrix:
        goos: [darwin, linux]
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          VERSION=$(grep '^version:' VERSION.yaml | awk '{print $2}' | tr -d '"')
          OUTPUT="safedownload-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}"
          go build -ldflags="-X main.Version=${VERSION}" -o "bin/${OUTPUT}" ./cmd/safedownload/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: safedownload-${{ matrix.goos }}-${{ matrix.goarch }}
          path: bin/

  # ===========================================================================
  # Documentation Validation
  # ===========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for broken links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress '**/*.md'
          fail: false  # Don't fail on broken links initially

      - name: Validate feature specs exist for roadmap
        run: |
          echo "Checking feature specs alignment with roadmap..."
          # Basic validation that specs directory exists
          if [[ ! -d dev/specs/features ]]; then
            echo "Warning: dev/specs/features directory missing"
          fi

  # ===========================================================================
  # All Checks Pass Gate
  # ===========================================================================
  all-checks:
    name: All Checks Pass
    runs-on: ubuntu-latest
    needs: [lint, test-bash, docs]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi
          if [[ "${{ needs.test-bash.result }}" != "success" ]]; then
            echo "Bash tests failed"
            exit 1
          fi
          if [[ "${{ needs.docs.result }}" != "success" ]]; then
            echo "Docs validation failed"
            exit 1
          fi
          echo "✅ All required checks passed"
